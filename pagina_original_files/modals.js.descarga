define(["$","sb/ooze","sb/notice","lib/jquery-wait","lib/jquery-xdomainrequest"],function(a,e,t){"use strict";var o=t.error,s=(t.notice,{}),l=[],n=function(e){var t={slide:["right","left","top","none"],stack:["true","false","replace"],flip:["none","right","left"],size:["regular","narrow","wide","small"],defaults:{href:"",slide:"right",flip:"none",stack:"true",title:"",size:null}};return{name:e.attr("data-modal")||console.warn("SB: Modal has no name:",e[0]),href:e.attr("data-modal-href")||t.defaults.href,slide:t.slide[a.inArray(e.attr("data-modal-slide"),t.slide)]||t.defaults.slide,flip:t.flip[a.inArray(e.attr("data-modal-flip"),t.flip)]||t.defaults.flip,stack:t.stack[a.inArray(e.attr("data-modal-stack"),t.stack)]||t.defaults.stack,title:e.attr("data-modal-title")||t.defaults.title,size:e.attr("data-modal-size")||t.defaults.size}},r=function(a){a=a||"";var e={account:"small","account-admins":"small","account-application":"small","account-links":"narrow","account-plan":"narrow","account-profile":"small","account-relationships":"wide","account-settings":"small","account-switcher":"narrow","add-admin":"small","add-card":"narrow","add-content":"small","add-new-photos":"small","add-photo-by-url":"small","add-photo-choose-from-album":"small","add-photo-existing":"small","add-photos-with-options":"small","add-promo-code":"small","asset-management":"small","audio-add":"small","audio-edit":"small","audio-playlist-buy-links":"narrow","audio-playlist-custom-fields":"small","blog-custom-fields":"small","cancel-order":"narrow","comment-settings":"small",content:"wide","contest-new-edit":"small","coupon-edit-codes":"small","coupon-new-and-edit":"small","create-short-url":"narrow","credit-card-prompt":"narrow","custom-domain-instructions":"narrow","custom-fields":"small","date-filter":"small","developer-settings":"small","edit-address":"narrow","edit-fan-list-filter":"small","edit-promo-code":"small","edit-report":"small","email-list":"small","email-list-notice":"small","email-list-signup":"narrow","employee-account-edit":"small","employee-user-edit":"small","endicia-account-edit":"small","endicia-postage":"narrow","event-add":"small","event-custom-fields":"small","event-tickets":"narrow","fan-club-join":"small","fan-club-membership":"narrow","fan-plan-change-history":"wide","fan-club-pricing":"small","fan-club-settings":"small","fan-club-submit":"small","fan-dashboard-welcome":"narrow","fanclub-content-categories":"narrow",fbpages:"narrow",flag:"small","forgot-password":"narrow","free-download":"narrow","fulfiller-new-and-edit":"narrow","gift-card-new-and-edit":"narrow","gmail-invite":"small","import-bands-in-town":"narrow",importer:"small","importer-add":"small","importer-new":"small","importer-new-edit":"small",integrations:"small",login:"narrow","manage-cards":"narrow","membership-tier-list":"narrow","navigation-settings":"small","new-navigation-item":"narrow","new-store-item-digital":"small","new-store-item-experience":"small","new-store-item-gift-card":"small","new-store-item-on-demand":"small","new-store-item-on-demand-tshirt":"small","new-store-item-physical":"small","new-store-item-preorder":"small","notification-types":"narrow","order-export":"narrow","order-guest-info":"narrow","order-mark-shipped":"narrow","order-create-shipment":"narrow","order-shipments":"narrow","order-shipping-label":"narrow","photo-album-custom-fields":"small","photo-edit":"small",preorder:"narrow","preorder-audio-selection":"narrow","products-export":"narrow","products-import":"narrow","promo-codes":"narrow","refund-order-by-amount":"small","refund-transaction":"small",relationships:"small","reset-password":"small","reorder-products":"small","richards-southern-export":"small","report-new-execution":"small","see-email-lists":"narrow","select-new-store-item":"small","set-list-new-edit":"small","set-list-track":"small",share:"small","shipments-export":"narrow",signup:"narrow","site-settings":"small","songkick-ticket-history":"narrow","songkick-integration":"narrow","applauze-ticket-history":"narrow","applauze-integration":"narrow","soundscan-export":"narrow",status:"small","stock-history":"wide","store-bundle":"small","store-custom-fields":"small","store-dashboard-welcome":"narrow","store-exports":"narrow","store-item-add":"small","store-item-on-demand-config":"small","store-item-option-groups":"small","store-item-price-breakdown":"narrow","store-notification-settings":"small","store-product-list":"narrow","store-revenue-stats":"narrow","store-settings":"small","store-top-products":"small","stripe-connect":"small","tag-menu":"small","theme-info":"small","theme-management":"small","theme-selector":"wide","transaction-export":"narrow","transaction-shipment":"narrow",user:"small","user-applications":"narrow","user-contest-entry":"small","user-groups":"narrow","user-group-add-user":"narrow","user-group-new-and-edit":"narrow","user-group-users":"narrow","user-info-prompt":"small","user-list":"small","user-password":"narrow","user-phone":"narrow","user-profile":"small","user-settings":"small","user-verification-prompt":"narrow","vendor-new-and-edit":"small","video-add":"small","video-edit":"small","video-playlist-custom-fields":"small"};return e[a]?e[a]:a.match(/^audio-(embed-)?widget/)?"small":a.match(/^audio-test-downloads/)?"small":a.match(/^hosted-site-product-quick-view/)?"small":a.match(/^photo-edit/)?"small":a.match(/^store-item-variation/)?"small":"regular"},i=function(e,t){if(e.hasClass("modal-s-semi-open"))return e.removeClass("modal-s-semi-open modal-s-semi-open-animated"),void 0;var o="right"===t?"translateX(100%)":"translateX(-100%)";e.css({overflow:"","-webkit-transform":o,transform:o}),a.noop(e[0].offsetWidth),e.addClass("modal-s-open"),a.noop(e[0].offsetWidth),e.css({"-webkit-transform":"",transform:""})},d=function(e,t){"right"===t?e.css({overflow:"hidden","-webkit-transform":"translateX(100%)",transform:"translateX(100%)"}):(e.addClass("modal-s-semi-open"),a("html").one("mousemove","*",function(){e.filter(".modal-s-semi-open").addClass("modal-s-semi-open-animated")}))},m=function(){var t=a(this).trigger("mouseleave focusout").parents("body").find(".tipsy").remove().end().end(),m=n(t),c=a('[data-modal-name="'+m.name+'"]:not([data-modal-ajaxed])').last(),p=!!c.length,u=a(),h=a(".modal-overlay"),w=a.Deferred().resolve(),g=a.Deferred().resolve(),b=m.size||r(m.name);if(0===c.length&&(c=a('<div class="modal"><div class="modal-body"/></div>').attr("data-modal-name",m.name).appendTo("body")),c.addClass("modal-m-"+b),h.length||(h=a('<div class="modal-overlay"/>').attr("data-modal-close","true").appendTo("body"),a("<div/>").addClass("js-safari-scroll-bug-fixer").height(Math.max(1e3,a(window).height())).appendTo(a(".js-modal-scroll-container").length?".js-modal-scroll-container":"body")),"ontouchstart"in window&&parseInt(c.find(".modal-body").css("max-width"),10)>=a(window).width()&&h.removeAttr("data-modal-close"),h.addClass("modal-overlay-s-open"),l.length&&(u=l.slice(-1)[0],c.parents().filter(u).length&&c.data("sb-modal-inception",u).appendTo("body")),"none"!==m.flip){var v=a("<div/>").addClass("modal modal-s-open modal-s-flipping").appendTo("body"),y=a("<div/>").addClass("modal-flip"),k=a("<div/>").hide().insertBefore(c.addClass("modal-s-open")),C=a("<div/>").hide().insertBefore(u);y.appendTo(v).append([u,c]),a.noop(y[0].offsetWidth),y.addClass("modal-flip-s-flip-"+m.flip),w=a.wait(400).then(function(){k.replaceWith(c),C.replaceWith(u),v.remove(),f(u),l.push(c)})}else if("none"===m.slide){if("false"===m.stack)a.each(l,function(){f(this)});else if("replace"===m.stack&&(f(u),l.length))var x=l.slice(-1)[0].addClass("modal-s-semi-open modal-s-semi-open-animated").one("transitionend","*",function(){x.css({"-webkit-transform":"",transform:""})});l.push(c.addClass("modal-s-open"))}else{if("top"!==m.slide&&u.length)a(".modal-s-semi-open").removeClass("modal-s-semi-open modal-s-semi-open-animated").css({"-webkit-transform":"translateX(-100%)",transform:"translateX(-100%)"}),i(c,m.slide),d(u,"right"===m.slide?"left":"right");else{var S="translateY("+(-1*(c.find("modal-body").outerHeight()||a(window).height())-40)+"px)",O=c.find(".modal-body").first();O.css({"-webkit-transform":S,transform:S}),a.noop(c[0].offsetWidth),c.addClass("modal-s-open"),a.noop(c[0].offsetWidth),c.find(".modal-body").first().css({"-webkit-transform":"",transform:""})}w=a.wait(400).then(function(){if("false"===m.stack)a.each(l,function(){f(this)});else if("replace"===m.stack&&(f(u),l.length))var e=l.slice(-1)[0].addClass("modal-s-semi-open modal-s-semi-open-animated").one("transitionend","*",function(){e.css({"-webkit-transform":"",transform:""})});l.push(c)})}if(m.href&&!p){if(m.title&&history.pushState){c.data("modal-revert-pushstate",{url:document.location.href,title:document.title});var j={url:m.href,title:m.title};history.pushState(j,j.title,j.url+location.search),document.title=j.title}c.attr("data-modal-ajaxed",!0).find(".modal-body").first().html('<div class="modal-loading"><span class="icon"></span></div>'),g=a.ajax({url:m.href,dataType:"html",success:function(o){!function(a,e){a&&a[1]?require([a[1]],e):e()}(o.match(/require\.run\('(.+)'/),function(){a(o).hasClass("modal-body")||a(o).find(":not(.modal) > .modal-body").length?c.find(".modal-body").first().replaceWith(o):c.find(".modal-body").first().html(o),c.find(".modal-flip").length&&c.addClass("modal-s-flipping"),e.drip("modals.open."+m.name,c[0],t)})}}).fail(function(a){s.back();try{a.responseJSON=JSON.parse(a.responseText)}catch(e){}o(a.responseJSON&&a.responseJSON.error||"An error occurred processing your request.")})}else e.drip("modals.open."+m.name,c[0],t);return a.when(w,g).done(function(){e.drip("_modals.hooks.open",c[0])}),c.data("options",m),!1},c=function(){var e=a(this).attr("data-modal-close")?a('[data-modal-name="'+a(this).attr("data-modal-close")+'"]').last():a(this).closest("[data-modal-name]").first(),t=a(".modal-overlay"),o=a(),s=e.data("modal-revert-pushstate");if(l.pop(),l.length){if(o=l.slice(-1)[0],i(o,"left"),d(e,"right"),l.length>=2){var n=l.slice(-2)[0];n.addClass("modal-s-semi-open modal-s-semi-open-animated").one("transitionend","*",function(){n.css({"-webkit-transform":"",transform:""})})}a.wait(400).then(function(){p(e)})}else e.css({"-webkit-transform":"translateY(100%)",transform:"translateY(100%)"}),t.fadeOut(400,function(){a(this).remove(),p(e)}),a(".js-safari-scroll-bug-fixer").remove();s&&s.title&&history.pushState&&(history.pushState(s,s.title,s.url),document.title=s.title)},f=function(e,t){l.splice(a.inArray(e,l),1),t&&e.hasClass("modal-s-semi-open")?(e.css({"-webkit-transform":"translateX(-100%)",transform:"translateX(-100%)"}),a.wait(200).then(function(){p(e)})):p(e)},p=function(t){if(e.drip("modals.close."+t.attr("data-modal-name"),t[0]),a(".tooltip-menu, .schedule-tooltip-s-visible").length&&a(".tooltip-menu-overlay").click(),t.attr("data-modal-ajaxed"))return t.remove(),void 0;t.removeClass(function(a,e){return e.split(/\s+/).filter(function(a){return/^modal-/.test(a)}).join(" ")}).css({overflow:"","-webkit-transform":"",transform:""}).removeData("modal-revert-pushstate").find(".modal-body").css({"-webkit-transform":"",transform:""});var o=t.data("sb-modal-inception");o&&o.length&&t.appendTo(o),t.removeData("sb-modal-inception")},u=function(t,o,l,n){a.ajax({xhrFields:{withCredentials:!0},url:o,data:l,type:n,success:function(o,l,n){n.responseJSON?(require(["sb/notice"],function(a){n.responseJSON.error?a.error(n.responseJSON.message||n.responseJSON.error):n.responseJSON.success&&a.notice(n.responseJSON.message||n.responseJSON.success)}),n.responseJSON.modal&&(n.responseJSON.modal.close?s.close():n.responseJSON.modal.back&&s.back())):(t.find(".modal-body").first().html(o),a(".modal-s-open").scrollTop(0),e.drip("_modals.hooks.open",t[0]))}})},h=function(e){var t=a(this).parents("[data-modal-name]").first();return 0===t.find('input[type="file"]').filter(function(){return a(this).val()}).length?(e.preventDefault(),u(t,a(this).attr("action"),a(this).serialize(),a(this).attr("method")),!1):void 0},w=function(){return a.each(l.slice(0,-1),function(){f(this,!0)}),l[0]&&c.apply(l[0][0]),s};s.open=function(e,t,o,l,n,r){return a("<div/>",{"data-modal":e,"data-modal-href":t,"data-modal-title":o,"data-modal-slide":l,"data-modal-flip":n,"data-modal-stack":r}).appendTo("body").click().remove(),s},s.canClose=function(a,e){return"ask"===a?s.close=function(){return confirm(e||"Are you sure you want to cancel?")?(s.close=w,w()):s}:(s.close=w,l.slice(-1)[0].toggleClass("modal-s-unclosable",!a)),s},s.close=w,s.back=function(){return l.length&&c.apply(l.slice(-1)[0][0]),s},s.success=function(){var a=Array.prototype.slice.call(arguments,0),t=l.slice(-1)[0];return a.unshift("modals.success."+t.attr("data-modal-name"),t[0]),e.drip.apply(this,a),s.close()},s.getStackSize=function(){return l.length},s.refresh=function(e){var t=l.slice(-1)[0]||a(),o=t.data("options")||{};return o.href?(t.off(),e||(t.html(a('<div class="modal-body"><div class="modal-loading"><span class="icon"></span></div></div>').css("min-height",t.find(".modal-body").first().height())).scrollTop(0),e=function(e,t){a(e).hasClass("modal-body")||a(e).find(":not(.modal) > .modal-body").length?t.find(".modal-body").replaceWith(e):t.find(".modal-body").removeAttr("style").html(e)}),a.ajax({url:o.href,dataType:"html",success:function(o){e(o,t),t.find("[data-modal-autofocus]").focus();var s=a.map(l,function(e){return a(e).attr("data-modal-name")});t.find("[data-modal-back]").each(function(){var e=a(this).attr("data-modal-back");e&&-1===a.inArray(e,s)&&a(this).remove()})}}),s):s},s.flip=function(){var e=l.slice(-1)[0];if(!e)return console.warn("SB: modals.flip() cannot be called without an open modal");var t=e.find(".modal-flip");return t.length?(a(document).one("transitionend","*",function(){a(window).resize();var e=t.find("> :first-child");return e.insertAfter(e.next()),t.removeClass("modal-flip-s-flip-left modal-flip-s-flip-right"),!1}),t.attr("data-modal-flipped")?t.removeAttr("data-modal-flipped").addClass("modal-flip-s-flip-right"):t.attr("data-modal-flipped","true").addClass("modal-flip-s-flip-left"),void 0):console.warn("SB: current modal does not have flipping container")},a(function(){a("body").on("click.sbModals","[data-modal]",m).on("mouseup.sbModals","[data-modal]",function(){a(this).blur()}).on("click.sbModals","[data-modal-back]:not([data-modal])",function(a){a.preventDefault(),c.apply(l.slice(-1)[0][0])}).on("click.sbModals touchend.sbModals","[data-modal-close]",function(e){a(this).attr("data-modal-close")&&e.preventDefault(),s.close()}).on("submit.sbModals","[data-modal-form]",h).on("click.sbModals",".modal-s-semi-open",s.back),a(window).mousemove(function(e){if(e.clientX<=a(window).width()-17||0===s.getStackSize())return a("html").removeClass("modal-scrollbar-fix"),void 0;var t=l.slice(-1)[0],o=t.find(".modal-flip > *"),n=(o.length?o.first():t)[0];a("html").toggleClass("modal-scrollbar-fix",n.scrollHeight>n.clientHeight)}).keyup(function(t){27!==t.which||!l.length||t.metaKey||t.ctrlKey||a(":input:focus").length||e.drip("modals.do.back")})}),e.on("modals.do.back",s.back).on("modals.do.close",w).on("_modals.hooks.open",function(e){var t=a(e);window.top===window&&t.find("[data-modal-autofocus]").focus();var o=a.map(l,function(e){return a(e).attr("data-modal-name")});t.find("[data-modal-back]").not('[data-modal-back=""]').each(function(){var e=a(this).attr("data-modal-back");e&&-1===a.inArray(e,o)&&a(this).remove()}),t.find("[data-modal-autoback]").length&&s.back(),t.find("[data-modal-autoclose]").length&&s.close(),setTimeout(function(){t.css("-webkit-overflow-scrolling","auto"),a.noop(t[0].offsetWidth),t.css("-webkit-overflow-scrolling","touch"),a.noop(t[0].offsetWidth)},140)});var g=window.sb=window.sb||{};return g.modals=a.extend({},s,{on:function(a,t,o){return e.on(["modals",a,t],o),g.modals},close:function(){return e.drip("modals.do.close"),g.modals},one:function(a,t,o){return e.once(["modals",a,t],o),g.modals},off:function(a,t){return e.removeAllListeners(["modals",a,t]),g.modals}}),s});